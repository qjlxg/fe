name: 07-fund_warning_report_v5_1.yml

on:
  # 1. è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼šç›¸å…³ä»£ç æˆ–æ•°æ®æ›´æ–°æ—¶è¿è¡Œ
  push:
    paths:
      - 'analyzer_V5.py' # å»ºè®®å°†æ–°è„šæœ¬å‘½åä¸º analyzer_V5.py æˆ–åœ¨æ­¤å¤„ä¿®æ”¹
      - '.github/workflows/07-fund_warning_report.yml'
      - 'fund_data/**.csv'

  # 2. å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 02:00 è¿è¡Œ (UTC 18:00)
  schedule:
    - cron: '0 18 * * *' 
    
  # 3. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  analyze_funds:
    # è®¾ç½®ç¯å¢ƒæ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
    env:
      TZ: Asia/Shanghai
      
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´è®°å½•ä»¥æ”¯æŒ rebase

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # æ ¸å¿ƒä¾èµ–ï¼špandas, numpy ç”¨äºè®¡ç®—ï¼›pytz ç”¨äºæ—¶é—´æˆ³
          pip install pandas numpy pytz

      - name: Run fund analysis script (V5.1)
        id: analysis
        run: python analyzer_V5.py

      - name: Commit and push report
        if: success()
        run: |
          # é…ç½® Git èº«ä»½
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # å…³é”®ä¿®æ”¹ï¼šåŒ¹é… V5.1 è„šæœ¬ç”Ÿæˆçš„æ–‡ä»¶åæ ¼å¼ Report_V5_1_*.md
          # åŒæ—¶å…¼å®¹æ—§ç‰ˆå‘½åçš„å‰ç¼€åŒ¹é…
          git add '**/Report_V5_1_*.md' || true
          git add '**/fund_warning_report_*.md' || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æŠ¥å‘Šç”Ÿæˆ
          if [ -z "$(git status --porcelain)" ]; then
            echo "No new report changes to commit. Exiting."
            exit 0
          fi
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ“ˆ [Automated] Fund V5.1 Analysis Report: $(date +'%Y-%m-%d %H:%M')"
          
          # å†²çªå¤„ç†ï¼šæ‹‰å–æœ€æ–°è¿œç¨‹æäº¤å¹¶ rebase
          git pull --rebase
          
          # æ¨é€
          git push
