name: 07-fund_warning_report_v5_1

on:
  # 1. è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼šç›¸å…³ä»£ç æˆ–æ•°æ®æ›´æ–°æ—¶è¿è¡Œ
  push:
    paths:
      - 'analyzer_V5.py'
      - '.github/workflows/07-fund_warning_report.yml'
      - 'fund_data/**.csv'

  # 2. å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 02:00 è¿è¡Œ (UTC 18:00)
  schedule:
    - cron: '0 18 * * *' 
    
  # 3. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  analyze_funds:
    # è®¾ç½®ç¯å¢ƒæ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼Œç¡®ä¿æŠ¥å‘Šä¸­çš„æ—¶é—´æˆ³æ­£ç¡®
    env:
      TZ: Asia/Shanghai
      
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²è®°å½•ä»¥æ”¯æŒ rebase

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…è®¡ç®—å’Œæ—¶åŒºæ‰€éœ€çš„ä¾èµ–
          pip install pandas numpy pytz

      - name: Run fund analysis script
        id: analysis
        run: python analyzer_V5.py

      - name: Commit and push report
        if: success()
        run: |
          # 1. é…ç½® Git èº«ä»½
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # 2. å¢å¼ºå‹æ–‡ä»¶æ·»åŠ é€»è¾‘
          # åŒæ—¶å°è¯•æ·»åŠ æ ¹ç›®å½•å’Œå­ç›®å½•ä¸‹çš„æ–°ç‰ˆ/æ—§ç‰ˆæŠ¥å‘Šæ–‡ä»¶ï¼Œä½¿ç”¨ || true å¿½ç•¥åŒ¹é…ä¸åˆ°çš„é”™è¯¯
          git add Report_V5_1_*.md || true
          git add **/Report_V5_1_*.md || true
          git add fund_warning_report_*.md || true
          git add **/fund_warning_report_*.md || true
          
          # 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶çœŸæ­£è¢«æ·»åŠ åˆ°æš‚å­˜åŒº
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected (No new reports or data). Skipping commit."
            exit 0
          fi
          
          # 4. æäº¤æ›´æ”¹
          git commit -m "ğŸ“ˆ [Automated] Fund V5.1 Analysis Report: $(date +'%Y-%m-%d %H:%M')"
          
          # 5. è§£å†³å¹¶å‘å†²çªï¼šæ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶ rebase
          # æ˜ç¡®æŒ‡å®šè¿œç¨‹åˆ†æ”¯ï¼Œå¢å¼ºç¨³å®šæ€§
          git pull --rebase origin main
          
          # 6. æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
