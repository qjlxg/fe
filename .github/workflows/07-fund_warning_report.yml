name: 07-fund_warning_report

on:
  # 1. è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼šä»£ç æˆ–æ•°æ®æ›´æ–°æ—¶è¿è¡Œ
  push:
    paths:
      - 'analyzer_V5.py'
      - '.github/workflows/**'
      - 'fund_data/**'

  # 2. å®šæ—¶ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤©å‡Œæ™¨ 02:00 è¿è¡Œ (UTC 18:00)
  schedule:
    - cron: '0 18 * * *' 
    
  # 3. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  analyze_funds:
    # è®¾ç½®ç¯å¢ƒæ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
    env:
      TZ: Asia/Shanghai
      
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ä»¥æ”¯æŒ rebase

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy pytz

      - name: Run fund analysis script
        id: analysis
        run: python analyzer_V5.py

      - name: Commit and push report
        if: success()
        run: |
          # 1. é…ç½® Git èº«ä»½
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # 2. é€šç”¨æ·»åŠ é€»è¾‘ï¼šæ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶
          # ä½¿ç”¨é€šé…ç¬¦ Report_*.md åŒ¹é…æ‰€æœ‰ç‰ˆæœ¬ï¼ˆV5.1, V5.2 ç­‰ï¼‰
          # åŒæ—¶æ·»åŠ æ—¥å¿—æ–‡ä»¶æ–¹ä¾¿æ’æŸ¥é—®é¢˜
          git add Report_*.md || true
          git add fund_analysis.log || true
          git add **/Report_*.md || true
          
          # 3. æ ¸å¿ƒæ£€æŸ¥ï¼šåˆ¤æ–­æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŠ¨
          # git status --porcelain ä¼šåˆ—å‡ºæ‰€æœ‰å˜åŠ¨ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸æäº¤
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes detected (No new reports). Skipping commit."
            exit 0
          fi
          
          # 4. æäº¤æ›´æ”¹
          git commit -m "ğŸ“ˆ [Automated] Fund Analysis Report: $(date +'%Y-%m-%d %H:%M')"
          
          # 5. å¤„ç†å¹¶å‘å†²çª
          # å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå¦‚æœæœ¬åœ°æœ‰æ–°æäº¤ï¼Œä½¿ç”¨ rebase ä¿æŒæäº¤çº¿æ•´æ´
          git pull --rebase origin main
          
          # 6. æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
