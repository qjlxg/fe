name: ğŸš€ å¤©æ¢ETFå®æˆ˜ç›‘æ§ç³»ç»Ÿ_V9.0

on:
  push:
    paths:
      - 'analyzer_V9.py'        # å»ºè®®æ”¹ä¸º V9 æ–‡ä»¶å
      - '.github/workflows/**'
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 15:15 è¿è¡Œ (UTC 7:15)
    - cron: '15 7 * * *'
  workflow_dispatch:           # æ”¯æŒæ‰‹åŠ¨è§¦å‘åˆ†æ

jobs:
  trading_system_run:
    env:
      TZ: Asia/Shanghai
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ä¸è´¦æœ¬
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # å¼€å¯ç¼“å­˜åŠ é€Ÿä¾èµ–å®‰è£…

      - name: ğŸ› ï¸ å®‰è£…é‡åŒ–æ ¸å¿ƒä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy akshare

      - name: ğŸ“ˆ æ‰§è¡Œ V9 æ ¸å¿ƒç³»ç»Ÿ
        # æ³¨æ„ï¼šè¿™é‡Œå»ºè®®åœ¨è„šæœ¬å¼€å¤´è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ update_etf_data() å‡½æ•°
        # æˆ–è€…ç›´æ¥åœ¨è¿™é‡Œè¿è¡Œ: python data_updater.py && python analyzer_V9.py
        run: python analyzer_V9.py

      - name: ğŸ’¾ åŒæ­¥è´¦æœ¬ä¸æŠ¥å‘Šè‡³ä»“åº“
        if: always() # å³ä½¿æŠ¥é”™ä¹Ÿå°è¯•ä¿å­˜æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # 1. å¼ºåˆ¶æ·»åŠ è´¦æœ¬æ–‡ä»¶ï¼Œé˜²æ­¢æŒä»“ä¸¢å¤±
          git add portfolio.csv || true
          
          # 2. æ·»åŠ æ•°æ®æ–‡ä»¶å¤¹å’Œæ—¥å¿—
          git add fund_data/*.csv || true
          git add strategy_log.csv || true
          git add *.md || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨éœ€è¦æäº¤
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰å‘ç°æ•°æ®æ›´æ–°ï¼Œè·³è¿‡æäº¤ã€‚"
            exit 0
          fi
          
          git commit -m "ğŸ“Š ç³»ç»Ÿè‡ªåŠ¨åŒæ­¥: $(date +'%Y-%m-%d %H:%M') [æŒä»“ç›‘æ§+ä¿¡å·æ‰«æ]"
          
          # ä½¿ç”¨ rebase ç­–ç•¥å¤„ç†æ½œåœ¨çš„å¹¶å‘å†²çª
          git pull --rebase origin main
          git push origin main
